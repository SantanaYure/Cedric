<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cedric Starwyn - Ficha Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --astral-glow: 0 0 15px rgba(168, 85, 247, 0.5);
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
        }

        h1, h2, h3, .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: var(--astral-glow);
        }

        .stat-input {
            background: transparent;
            border: none;
            color: inherit;
            text-align: center;
            width: 100%;
            font-weight: bold;
        }
        
        .stat-input:focus {
            outline: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9333ea; 
        }

        .editable-area {
            min-height: 100px;
            white-space: pre-wrap;
            cursor: text;
        }
        
        .btn-action {
            transition: transform 0.1s;
        }
        .btn-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4 glass-panel p-6 border-l-4 border-purple-500">
        <div>
            <h1 class="text-3xl md:text-4xl text-purple-400 font-bold tracking-wider editable" contenteditable="true" id="charName">Cedric Starwyn</h1>
            <p class="text-slate-400 mt-1">
                <span contenteditable="true" id="charClass">Monge (Caminho da Forma Astral)</span> • 
                Nível <span contenteditable="true" id="charLevel" class="font-bold text-white">5</span> • 
                <span contenteditable="true" id="charRace">Humano</span>
            </p>
        </div>
        <div class="flex gap-2">
            <button onclick="shortRest()" class="btn-action px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-2 text-sm font-bold border border-slate-600">
                <i data-lucide="coffee" class="w-4 h-4"></i> Descanso Curto
            </button>
            <button onclick="longRest()" class="btn-action px-4 py-2 bg-purple-900 hover:bg-purple-800 rounded flex items-center gap-2 text-sm font-bold border border-purple-700">
                <i data-lucide="moon" class="w-4 h-4"></i> Descanso Longo
            </button>
            <button onclick="resetData()" class="btn-action px-3 py-2 text-red-400 hover:text-red-300" title="Resetar Dados">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">

        <!-- Column 1: Attributes & Skills -->
        <div class="space-y-6 md:col-span-1">
            
            <!-- Vitals Mobile Friendly Stack -->
            <div class="glass-panel p-4 flex flex-col gap-4">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                    <span class="text-slate-400 font-cinzel">Iniciativa</span>
                    <input type="text" id="initiative" class="stat-input text-xl text-yellow-400 w-12" value="+3">
                </div>
                <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                    <span class="text-slate-400 font-cinzel">Classe de Armadura</span>
                    <input type="number" id="ac" class="stat-input text-xl text-blue-400 w-12" value="17">
                </div>
                <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                    <span class="text-slate-400 font-cinzel">Deslocamento</span>
                    <input type="text" id="speed" class="stat-input text-xl text-green-400 w-16" value="12m">
                </div>
                <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                    <span class="text-slate-400 font-cinzel">Proficiência</span>
                    <span id="profBonus" class="stat-input text-xl text-slate-200 w-12 text-right pr-2">+3</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400 font-cinzel">CD de Ki (Sab)</span>
                    <input type="number" id="saveDc" class="stat-input text-xl text-purple-400 w-12" value="15">
                </div>
            </div>

            <!-- Attributes -->
            <div class="grid grid-cols-2 gap-3" id="attributesContainer">
                <!-- Generated by JS -->
            </div>

            <!-- Skills List -->
            <div class="glass-panel p-4">
                <h3 class="font-cinzel text-lg text-purple-300 mb-3 border-b border-slate-700 pb-1">Perícias & Sentidos</h3>
                <div class="space-y-2 text-sm" id="skillsList">
                    <!-- Skills will be dynamically generated here -->
                </div>
                <textarea class="w-full mt-3 bg-slate-800 p-2 rounded text-xs text-slate-300 border border-slate-700 h-24" placeholder="Outras proficiências..." id="otherProficiencies">Armas Simples, Marciais (Leve), Ferramentas de Ladrão, Guitarra Clássica.</textarea>
            </div>
        </div>

        <!-- Column 2: Main Combat & Resources -->
        <div class="space-y-6 md:col-span-2">
            
            <!-- HP & KI Dashboard -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- HP -->
                <div class="glass-panel p-4 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="font-cinzel text-red-400 flex items-center gap-2"><i data-lucide="heart" class="w-4 h-4"></i> Pontos de Vida</label>
                        <div class="text-xs text-slate-500">Máximo: <input type="number" id="maxHp" class="w-10 bg-transparent text-right font-bold text-base" value="53"></div>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <button onclick="modStat('currentHp', -1)" class="btn-action w-10 h-10 rounded-full bg-slate-800 text-red-500 hover:bg-slate-700 flex items-center justify-center font-bold text-xl">-</button>
                        <input type="number" id="currentHp" class="text-4xl font-bold bg-transparent text-center w-24" value="53">
                        <button onclick="modStat('currentHp', 1)" class="btn-action w-10 h-10 rounded-full bg-slate-800 text-green-500 hover:bg-slate-700 flex items-center justify-center font-bold text-xl">+</button>
                    </div>
                    <div class="w-full bg-slate-800 h-1 mt-3 rounded overflow-hidden">
                        <div id="hpBar" class="h-full bg-red-600 transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>

                <!-- KI -->
                <div class="glass-panel p-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="font-cinzel text-cyan-400 flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> Pontos de Ki</label>
                        <div class="text-xs text-slate-500">Máximo: <input type="number" id="maxKi" class="w-8 bg-transparent text-right font-bold text-base" value="5"></div>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <button onclick="modStat('currentKi', -1)" class="btn-action w-10 h-10 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 flex items-center justify-center font-bold text-xl">-</button>
                        <input type="number" id="currentKi" class="text-4xl font-bold bg-transparent text-center w-24" value="5">
                        <button onclick="modStat('currentKi', 1)" class="btn-action w-10 h-10 rounded-full bg-slate-800 text-cyan-400 hover:bg-slate-700 flex items-center justify-center font-bold text-xl">+</button>
                    </div>
                     <!-- Ki Visualizer -->
                    <div class="flex justify-center gap-1 mt-3 h-2" id="kiBubbles">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Attacks -->
            <div class="glass-panel p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-cinzel text-xl text-slate-200">Ações & Ataques</h3>
                    <div class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">Ataque Extra (<input type="text" id="extraAttacks" class="bg-transparent w-10 text-center" value="2/turno">)</div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-slate-500 text-xs uppercase border-b border-slate-700">
                                <th class="pb-2 pl-2">Arma</th>
                                <th class="pb-2">Bônus</th>
                                <th class="pb-2">Dano</th>
                                <th class="pb-2">Notas</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm" id="attacksTable" contenteditable="true" style="white-space: pre-wrap;">
                            <!-- Pre-filled data, now editable -->
                            <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors group">
                                <td class="py-3 pl-2 font-bold text-purple-300"><i data-lucide="hand" class="inline w-4 h-4 mr-1"></i> Desarmado / Monge</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d8+3 <span class="text-xs text-slate-500">Concussão</span></td>
                                <td class="py-3 text-xs text-slate-400">Mágico (Nvl 6+), Ação Bônus</td>
                            </tr>
                            <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-purple-400"><i data-lucide="ghost" class="inline w-4 h-4 mr-1"></i> Braços Astrais</td>
                                <td class="py-3 text-green-400 font-bold">+7</td>
                                <td class="py-3">1d8+4 <span class="text-xs text-slate-500">Energia</span></td>
                                <td class="py-3 text-xs text-slate-400">Alcance +1.5m, Usa Sabedoria</td>
                            </tr>
                            <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-slate-300">Kusarigama</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d8+3 <span class="text-xs text-slate-500">Cortante</span></td>
                                <td class="py-3 text-xs text-slate-400">Alcance, Leve</td>
                            </tr>
                             <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-slate-300">Adaga</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d4+3 <span class="text-xs text-slate-500">Perfurante</span></td>
                                <td class="py-3 text-xs text-slate-400">Arremesso (6/18m)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Features Quick Reference -->
            <div class="glass-panel p-4" id="featuresContainer">
                <h3 class="font-cinzel text-lg text-yellow-500 mb-3"><i data-lucide="zap" class="inline w-4 h-4 mb-1"></i> Habilidades Ativas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="activeAbilities">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>

        <!-- Column 3: Inventory & Notes -->
        <div class="space-y-6 md:col-span-1">
            
            <!-- Wealth -->
            <div class="glass-panel p-4 flex flex-wrap justify-between items-center gap-2">
                <div class="flex items-center gap-2 text-yellow-500">
                    <i data-lucide="coins"></i> <span class="font-cinzel">PO</span>
                    <input type="number" id="gp" class="stat-input w-16 text-yellow-400 font-mono" value="555">
                </div>
                <div class="flex items-center gap-2 text-slate-400">
                    <i data-lucide="gem"></i> <span class="font-cinzel">PP</span>
                    <input type="number" id="pp" class="stat-input w-12 font-mono" value="0">
                </div>
                <div class="flex items-center gap-2 text-amber-100">
                    <i data-lucide="circle-dollar-sign"></i> <span class="font-cinzel">PE</span>
                    <input type="number" id="ep" class="stat-input w-12 font-mono" value="0">
                </div>
                 <div class="flex items-center gap-2 text-orange-400">
                    <i data-lucide="copper-coin"></i> <span class="font-cinzel">PC</span>
                    <input type="number" id="cp" class="stat-input w-12 font-mono" value="0">
                </div>
            </div>

            <!-- Inventory -->
            <div class="glass-panel p-4 flex flex-col h-64">
                <h3 class="font-cinzel text-lg text-slate-300 mb-2">Equipamentos</h3>
                <textarea id="inventory" class="w-full flex-1 bg-slate-800/50 border-none rounded p-2 text-sm text-slate-300 resize-none focus:ring-1 focus:ring-purple-500 outline-none" placeholder="Adicione itens aqui...">Pacote de Explorador
Guitarra Clássica
5 Adagas
Kusarigama
2 Algibeiras
Roupas de Viagem
Saco de Dormir
Poção de Cura (Oboro)
                </textarea>
            </div>

            <!-- Notes -->
            <div class="glass-panel p-4 flex flex-col h-auto">
                <h3 class="font-cinzel text-lg text-slate-300 mb-2">Anotações / Missão</h3>
                <textarea id="notes" class="w-full h-48 bg-slate-800/50 border-none rounded p-2 text-sm text-slate-300 resize-y focus:ring-1 focus:ring-purple-500 outline-none" placeholder="Suas anotações...">Missão: Proteger senhora no Arenal.
Inimigo: A Mancha (Escamengo).
Mestre: Nahim (Equilíbrio Corpo/Mente/Alma).
Contatos: Maria Tasha, Flor de Prata.
Inimigos: Família Starwyn (Aurix), Shampa.
                </textarea>
            </div>
            
             <!-- Feats Small Block -->
             <div class="glass-panel p-4">
                <h3 class="font-cinzel text-sm text-slate-400 mb-2 border-b border-slate-700">Talentos</h3>
                <ul class="text-xs space-y-2" id="featsList">
                   <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURES & DEFAULTS ---

        const defaultSheetData = {
            // Char Info
            charName: "Cedric Starwyn",
            charClass: "Monge (Caminho da Forma Astral)",
            charLevel: 5,
            charRace: "Humano",
            // Vitals
            initiative: "+3",
            ac: 17,
            speed: "12m",
            profBonus: "+3",
            saveDc: "15",
            // Resources
            currentHp: 53, maxHp: 53,
            currentKi: 5, maxKi: 5,
            // Attributes
            str: 8, dex: 16, con: 16, int: 10, wis: 18, cha: 13,
            // Skills
            skills: {
                passive_perception: { value: 17, proficient: false, source: "" },
                insight: { value: "+7", proficient: true, source: "Origem" },
                perception: { value: "+7", proficient: true, source: "Linhagem" },
                acrobatics: { value: "+6", proficient: true, source: "" },
                stealth: { value: "+6", proficient: true, source: "Origem" },
                history: { value: "+3", proficient: false, source: "" }
            },
            otherProficiencies: "Armas Simples, Marciais (Leve), Ferramentas de Ladrão, Guitarra Clássica.",
             // Attacks
            attacksTable: `<tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors group">
                                <td class="py-3 pl-2 font-bold text-purple-300"><i data-lucide="hand" class="inline w-4 h-4 mr-1"></i> Desarmado / Monge</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d8+3 <span class="text-xs text-slate-500">Concussão</span></td>
                                <td class="py-3 text-xs text-slate-400">Mágico (Nvl 6+), Ação Bônus</td>
                            </tr>
                            <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-purple-400"><i data-lucide="ghost" class="inline w-4 h-4 mr-1"></i> Braços Astrais</td>
                                <td class="py-3 text-green-400 font-bold">+7</td>
                                <td class="py-3">1d8+4 <span class="text-xs text-slate-500">Energia</span></td>
                                <td class="py-3 text-xs text-slate-400">Alcance +1.5m, Usa Sabedoria</td>
                            </tr>
                            <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-slate-300">Kusarigama</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d8+3 <span class="text-xs text-slate-500">Cortante</span></td>
                                <td class="py-3 text-xs text-slate-400">Alcance, Leve</td>
                            </tr>
                             <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                                <td class="py-3 pl-2 font-bold text-slate-300">Adaga</td>
                                <td class="py-3 text-green-400 font-bold">+6</td>
                                <td class="py-3">1d4+3 <span class="text-xs text-slate-500">Perfurante</span></td>
                                <td class="py-3 text-xs text-slate-400">Arremesso (6/18m)</td>
                            </tr>`,
            extraAttacks: "2/turno",
            // Active Abilities
            activeAbilities: [
                { id: "astralArms", name: "Braços Astrais", cost: "1 Ki", color: "text-purple-400", desc: "Ação Bônus. 10 mins. Dano em área ao ativar (2d8). Usa SAB para Atq/Dano. Alcance +1.5m.", uses: 0, maxUses: 0, reset: 'none' },
                { id: "stunningStrike", name: "Ataque Atordoante", cost: "1 Ki", color: "text-cyan-400", desc: "Ao acertar. TR Constituição (CD 15) ou Atordoado até final do seu próx. turno.", uses: 0, maxUses: 0, reset: 'none' },
                { id: "supernaturalMetabolism", name: "Metabolismo Sobrenatural", cost: "1x/LR", color: "text-yellow-400", desc: "Na iniciativa: Recupera todo KI e 5 + 1d8 PV.", uses: 0, maxUses: 1, reset: 'long' },
                { id: "focusedAim", name: "Mira Focada", cost: "1-3 Ki", color: "text-green-400", desc: "Se errar ataque, gaste Ki. +2 no ataque por ponto gasto.", uses: 0, maxUses: 0, reset: 'none' },
                { id: "flurryOfBlows", name: "Rajada de Golpes", cost: "1 Ki", color: "text-slate-300", desc: "Logo após ataque, faça 2 ataques desarmados como Ação Bônus.", uses: 0, maxUses: 0, reset: 'none' }
            ],
            // Feats
            feats: [
                { id: "lucky", name: "Sortudo", desc: "Ganhe Vantagem em um teste ou imponha Desvantagem em um ataque contra você.", uses: 0, maxUses: 'prof', reset: 'long' },
                { id: "tough", name: "Vigoroso", desc: "+2 PV/nível", uses: 0, maxUses: 0, reset: 'none' },
                { id: "resilient", name: "Resiliente (Sab)", desc: "Prof. em TR", uses: 0, maxUses: 0, reset: 'none' },
            ],
            // Wealth
            gp: 555, pp: 0, ep: 0, cp: 0,
            // Inventory & Notes
            inventory: `Pacote de Explorador
Guitarra Clássica
5 Adagas
Kusarigama
2 Algibeiras
Roupas de Viagem
Saco de Dormir
Poção de Cura (Oboro)`,
            notes: `Missão: Proteger senhora no Arenal.
Inimigo: A Mancha (Escamengo).
Mestre: Nahim (Equilíbrio Corpo/Mente/Alma).
Contatos: Maria Tasha, Flor de Prata.
Inimigos: Família Starwyn (Aurix), Shampa.`,
        };

        const attrNames = {
            str: "Força", dex: "Destreza", con: "Constituição",
            int: "Inteligência", wis: "Sabedoria", cha: "Carisma"
        };
        
        const skillNames = {
            passive_perception: "Percepção Passiva",
            insight: "Intuição",
            perception: "Percepção",
            acrobatics: "Acrobacia",
            stealth: "Furtividade",
            history: "História",
        };

        // --- CORE SCRIPT ---

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadSheet();
            attachAllListeners();
        });

        function getSheetData() {
            const storedData = localStorage.getItem('charSheetData');
            if (storedData) {
                try {
                    // Merge stored data with defaults to ensure all keys are present
                    const parsed = JSON.parse(storedData);
                    return { ...defaultSheetData, ...parsed };
                } catch(e) {
                    console.error("Failed to parse saved data, using defaults.", e);
                    return defaultSheetData;
                }
            }
            return defaultSheetData;
        }

        function saveSheetData(data) {
            localStorage.setItem('charSheetData', JSON.stringify(data));
        }

        function calculateProficiencyBonus(level) {
            if (level < 5) return 2;
            if (level < 9) return 3;
            if (level < 13) return 4;
            if (level < 17) return 5;
            return 6;
        }

        function loadSheet() {
            const data = getSheetData();
            
            // Auto-calculate proficiency bonus from level
            const level = parseInt(data.charLevel, 10) || 1;
            data.profBonus = `+${calculateProficiencyBonus(level)}`;
            
            // Simple value fields
            const simpleFields = ["charName", "charClass", "charLevel", "charRace", "initiative", "ac", "speed", "profBonus", "saveDc", "currentHp", "maxHp", "currentKi", "maxKi", "gp", "pp", "ep", "cp", "inventory", "notes", "otherProficiencies", "extraAttacks"];
            simpleFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const value = data[id] ?? defaultSheetData[id];
                     if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = value;
                     else el.innerText = value;
                }
            });
            
            // Attacks table
            const attacksTable = document.getElementById('attacksTable');
            if (attacksTable) attacksTable.innerHTML = data.attacksTable;

            renderAttributes(data);
            renderSkills(data);
            renderAbilities(data);
            renderFeats(data);
            updateBars();
            lucide.createIcons(); // Re-run lucide after dynamic content is added
        }

        function attachAllListeners() {
            // Generic save on input
            document.querySelectorAll('input, textarea, [contenteditable]').forEach(el => {
                el.addEventListener('input', (e) => {
                    const data = getSheetData();
                    const id = e.target.id;
                    let value = e.target.value ?? e.target.innerText;

                    // This generic handler saves most top-level properties
                    if (id && data.hasOwnProperty(id)) {
                        data[id] = value;
                    }
                    
                    // Special case for contenteditable tables
                    if (e.currentTarget.id === 'attacksTable') {
                        data.attacksTable = e.currentTarget.innerHTML;
                    }
                    
                    saveSheetData(data);
                    
                    // If level changes, reload everything to update calculated values
                    if (id === 'charLevel') {
                        loadSheet();
                    } 
                    // For simple resource changes, just update the bars for responsiveness
                    else if (id && (id.includes('Hp') || id.includes('Ki'))) {
                        updateBars();
                    }
                });
            });
        }

        // --- RENDER FUNCTIONS ---
        
        function getMod(score) {
            const mod = Math.floor((score - 10) / 2);
            return mod >= 0 ? `+${mod}` : mod.toString();
        }

        function renderAttributes(data) {
            const container = document.getElementById('attributesContainer');
            container.innerHTML = '';
            Object.keys(attrNames).forEach(key => {
                const score = data[key] ?? defaultSheetData[key];
                const mod = getMod(score);
                const modColor = parseInt(mod) > 0 ? 'text-green-400' : (parseInt(mod) < 0 ? 'text-red-400' : 'text-slate-500');

                const div = document.createElement('div');
                div.className = "glass-panel p-3 flex flex-col items-center justify-center";
                div.innerHTML = `
                    <label class="text-xs uppercase tracking-widest text-slate-500 font-bold">${attrNames[key].substring(0,3)}</label>
                    <span class="text-2xl font-bold ${modColor} font-cinzel">${mod}</span>
                    <input type="number" id="attr_${key}" value="${score}" 
                        class="stat-input w-12 text-sm mt-1"
                        onchange="updateAttribute('${key}', this.value)">
                `;
                container.appendChild(div);
            });
        }
        
        function renderSkills(data) {
            const container = document.getElementById('skillsList');
            container.innerHTML = '';
            Object.keys(skillNames).forEach(key => {
                const skill = data.skills[key] ?? defaultSheetData.skills[key];
                const sourceText = skill.source ? `<span class="text-xs text-slate-500 ml-1">(${skill.source})</span>` : '';
                const div = document.createElement('div');
                div.className = "flex justify-between items-center";
                div.innerHTML = `
                    <span class="text-slate-400">${skillNames[key]}${sourceText}</span>
                    <input type="text" id="skill_${key}" class="stat-input w-12 font-bold text-white text-right" value="${skill.value}">
                `;
                container.appendChild(div);
                
                document.getElementById(`skill_${key}`).addEventListener('input', (e) => {
                    const currentData = getSheetData();
                    currentData.skills[key].value = e.target.value;
                    saveSheetData(currentData);
                });
            });
        }
        
        function renderAbilities(data) {
            const container = document.getElementById('activeAbilities');
            container.innerHTML = '';
            data.activeAbilities.forEach((ability, index) => {
                const div = document.createElement('div');
                div.className = `bg-slate-800/50 p-3 rounded border border-slate-700 relative cursor-pointer hover:border-purple-500 transition-colors`;
                div.onclick = () => useAbility(index);
                
                let usageText = '';
                if (ability.maxUses > 0) {
                     usageText = `<span class="absolute top-2 right-2 text-xs font-mono">${ability.uses}/${ability.maxUses}</span>`;
                }

                div.innerHTML = `
                    <strong class="${ability.color} block mb-1">${ability.name} <span class="text-xs text-slate-500">(${ability.cost})</span></strong>
                    <p class="text-xs text-slate-300 pr-8">${ability.desc}</p>
                    ${usageText}
                `;
                container.appendChild(div);
            });
        }
        
         function renderFeats(data) {
            const container = document.getElementById('featsList');
            container.innerHTML = '';
            data.feats.forEach((feat, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center cursor-pointer hover:text-yellow-300';
                li.onclick = () => useFeat(index);

                let usageText = '';
                let max = feat.maxUses;
                if (max === 'prof') {
                    max = parseInt(data.profBonus) || 0;
                }
                
                if (max > 0) {
                    usageText = `<span class="text-xs font-mono text-slate-400">${feat.uses} / ${max}</span>`;
                } else {
                    usageText = `<span class="text-slate-400">${feat.desc}</span>`;
                }

                li.innerHTML = `<strong class="text-white">${feat.name}</strong> ${usageText}`;
                container.appendChild(li);
            });
        }

        // --- UPDATE & LOGIC FUNCTIONS ---

        function updateAttribute(key, value) {
            const data = getSheetData();
            data[key] = parseInt(value, 10);
            saveSheetData(data);
            loadSheet(); // Recalculate skills and other derived stats
        }

        function useAbility(index) {
            const data = getSheetData();
            const ability = data.activeAbilities[index];

            // Step 1: Check if the ability has limited uses and if they are all spent.
            if (ability.maxUses > 0 && ability.uses >= ability.maxUses) {
                alert(`Não há mais usos de "${ability.name}" disponíveis.`);
                return;
            }

            const costString = ability.cost.toLowerCase();
            let kiCost = 0;

            // Step 2: Determine the Ki cost.
            if (costString.includes('ki')) {
                // Handle variable costs like "1-3 Ki"
                if (costString.includes('-')) {
                    const parts = costString.replace('ki', '').trim().split('-');
                    const min = parseInt(parts[0], 10);
                    const max = parseInt(parts[1], 10);
                    const promptMessage = `Gastar quantos pontos de Ki para "${ability.name}"? (min: ${min}, max: ${max})`;
                    const spent = prompt(promptMessage, min);

                    if (spent === null) return; // User cancelled

                    kiCost = parseInt(spent, 10);

                    if (isNaN(kiCost) || kiCost < min || kiCost > max) {
                        alert("Valor inválido.");
                        return;
                    }
                } else {
                    // Handle fixed costs like "1 Ki"
                    kiCost = parseInt(costString, 10) || 0;
                }

                // Step 3: Check if enough Ki is available.
                if (data.currentKi < kiCost) {
                    alert("Pontos de Ki insuficientes.");
                    return;
                }
            }

            // Step 4: Deduct Ki and increment uses.
            if (kiCost > 0) {
                data.currentKi -= kiCost;
            }
            if (ability.maxUses > 0) {
                ability.uses++;
            }

            // Step 5: Save data and refresh the sheet to reflect changes.
            saveSheetData(data);
            loadSheet();
        }
        
        function useFeat(index) {
            const data = getSheetData();
            const feat = data.feats[index];
            let maxUses = feat.maxUses;
            if(maxUses === 'prof') {
                maxUses = parseInt(data.profBonus) || 0;
            }

            if (maxUses > 0) {
                if (feat.uses < maxUses) {
                    feat.uses++;
                    saveSheetData(data);
                    renderFeats(data);
                } else {
                    alert(`Não há mais usos de "${feat.name}" disponíveis.`);
                }
            }
        }

        function modStat(id, amount) {
            const data = getSheetData();
            let val = parseInt(data[id]);
            let maxId = id.replace('current', 'max');
            let max = parseInt(data[maxId]);
            
            val += amount;
            
            if (id.includes('Ki') || id.includes('Hp')) {
                if (val < 0) val = 0;
                if (val > max) val = max;
            }
            
            data[id] = val;
            saveSheetData(data);
            
            // Update UI directly for responsiveness
            document.getElementById(id).value = val;
            updateBars();
        }

        function updateBars() {
            const data = getSheetData();
            // HP Bar
            const pct = Math.max(0, Math.min(100, (data.currentHp / data.maxHp) * 100));
            const hpBar = document.getElementById('hpBar');
            if(hpBar) hpBar.style.width = `${pct}%`;
            
            // Ki Bubbles
            const kiContainer = document.getElementById('kiBubbles');
            if (kiContainer) {
                kiContainer.innerHTML = '';
                for(let i = 0; i < data.maxKi; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = `h-2 w-2 rounded-full transition-colors ${i < data.currentKi ? 'bg-cyan-400 shadow-[0_0_5px_cyan]' : 'bg-slate-700'}`;
                    kiContainer.appendChild(bubble);
                }
            }
        }
        
        // --- REST & RESET ---

        function shortRest() {
            if(!confirm("Realizar Descanso Curto?")) return;
            const data = getSheetData();
            data.currentKi = data.maxKi;
            
            data.activeAbilities.forEach(a => { if(a.reset === 'short') a.uses = 0; });
            data.feats.forEach(f => { if(f.reset === 'short') f.uses = 0; });

            saveSheetData(data);
            loadSheet(); // Full reload to reflect all changes
        }

        function longRest() {
            if(!confirm("Realizar Descanso Longo?")) return;
            const data = getSheetData();
            data.currentHp = data.maxHp;
            data.currentKi = data.maxKi;

            data.activeAbilities.forEach(a => { if(a.reset === 'short' || a.reset === 'long') a.uses = 0; });
            data.feats.forEach(f => { if(f.reset === 'short' || f.reset === 'long') f.uses = 0; });
            
            saveSheetData(data);
            loadSheet();
        }

        function resetData() {
            if(confirm("TEM CERTEZA?\nIsso irá apagar todos os dados salvos e restaurar a ficha para o padrão.")) {
                localStorage.removeItem('charSheetData');
                window.location.reload();
            }
        }
    </script>
</body>
</html>